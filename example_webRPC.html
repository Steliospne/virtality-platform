<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unity WebRTC Manual Client</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
        }

        .container {
            display: flex;
            gap: 20px;
        }

        .controls {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .video-container {
            flex: 2;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        video {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
            border-radius: 8px;
        }

        textarea {
            height: 150px;
        }

        button {
            padding: 10px;
            cursor: pointer;
        }

        #logs {
            height: 200px;
            overflow-y: auto;
            border: 1px solid #ccc;
            background: #f9f9f9;
            padding: 5px;
            font-size: 12px;
            white-space: pre-wrap;
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <h1>Unity WebRTC Manual Client</h1>
    <div class="container">
        <div class="controls">
            <h3>1. Paste Offer from Unity Here:</h3>
            <textarea id="localOffer" placeholder="Paste Offer JSON here..."></textarea>
            <button onclick="onOffer()">Create Answer</button>

            <h3>2. Copy Answer to Unity:</h3>
            <textarea id="remoteAnswer" placeholder="Answer JSON will appear here..."></textarea>

            <h3>Logs:</h3>
            <div id="logs"></div>
        </div>
        <div class="video-container">
            <video id="remoteVideo" autoplay playsinline controls muted></video>
        </div>
    </div>

    <script>
        const remoteVideo = document.getElementById('remoteVideo');
        const localOfferInput = document.getElementById('localOffer');
        const remoteAnswerOutput = document.getElementById('remoteAnswer');
        const logs = document.getElementById('logs');

        let pc;

        function log(msg) {
            console.log(msg);
            const entry = document.createElement('div');
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logs.appendChild(entry);
            logs.scrollTop = logs.scrollHeight;
        }

        async function onOffer() {
            try {
                const offerJson = localOfferInput.value;
                if (!offerJson) return alert('Please paste the offer JSON first');

                const offerDesc = JSON.parse(offerJson);
                // Handle various types of casing from Unity/Newtonsoft
                offerDesc.type = offerDesc.type.toLowerCase();

                log("Initializing PeerConnection...");
                pc = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                });

                pc.ontrack = event => {
                    log("Track received: " + event.track.kind);
                    if (remoteVideo.srcObject) return; // Already have it

                    if (event.streams && event.streams[0]) {
                        remoteVideo.srcObject = event.streams[0];
                    } else {
                        log("No stream found, creating one for track.");
                        remoteVideo.srcObject = new MediaStream([event.track]);
                    }
                };

                pc.onicecandidate = event => {
                    if (event.candidate) {
                        log("New ICE Candidate generated (see console if needed).");
                    }
                };

                pc.oniceconnectionstatechange = () => {
                    log(`ICE Connection State: ${pc.iceConnectionState}`);
                    if (pc.iceConnectionState === 'failed') {
                        log("Connection failed. Ensure both sides are on the same network or have STUN access.");
                    }
                };

                await pc.setRemoteDescription(offerDesc);
                log("Remote Description (Offer) set.");

                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);

                log("Gathering ICE candidates... please wait.");
                // Wait for ICE gathering to complete before displaying the answer
                await new Promise(resolve => {
                    if (pc.iceGatheringState === 'complete') {
                        resolve();
                    } else {
                        const checkState = () => {
                            if (pc.iceGatheringState === 'complete') {
                                pc.removeEventListener('icegatheringstatechange', checkState);
                                resolve();
                            }
                        };
                        pc.addEventListener('icegatheringstatechange', checkState);
                    }
                });

                remoteAnswerOutput.value = JSON.stringify(pc.localDescription);
                log("Answer created (complete with candidates)! Copy it back to Unity.");

            } catch (e) {
                console.error(e);
                log(`Error: ${e.message}`);
            }
        }
    </script>
</body>

</html>